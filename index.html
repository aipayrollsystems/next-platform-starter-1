import React, { useMemo, useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, BarChart, Bar } from 'recharts';

// ---------- Mock Data ----------
const payrollSeries = [
  { month: 'Apr', payroll: 170000 },
  { month: 'May', payroll: 184320 },
  { month: 'Jun', payroll: 210450 },
  { month: 'Jul', payroll: 198300 },
  { month: 'Aug', payroll: 230900 },
  { month: 'Sep', payroll: 245100 }
];

const employeesMock = Array.from({ length: 58 }).map((_, i) => ({
  id: 1000 + i,
  name: ['John Davis','Maria Lopez','Chris Taylor','Ava Morgan','Diego Ruiz','Linda Park'][i % 6],
  role: ['HVAC Technician','Welder','Electrician','Plumber','Nurse'][i % 5],
  hours: Math.round(30 + Math.random() * 40),
  rate: [32,28,30,26,40][i % 5],
  bank: `****${1000 + i}`,
  lastPaid: `2025-09-${(i%28)+1}`
}));

const paymentsMock = employeesMock.slice(0,12).map((e, i) => ({
  id: 'P' + (4000 + i),
  employee: e.name,
  role: e.role,
  amount: (e.hours * e.rate).toFixed(2),
  status: i % 3 === 0 ? 'Paid' : i % 3 === 1 ? 'Processing' : 'Scheduled',
  date: `2025-09-${(i%28)+1}`
}));

// ---------- Utility ----------
function formatCurrency(v) { return '$' + Number(v).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); }
function downloadCSV(filename, rows) {
  const csv = [Object.keys(rows[0]).join(','), ...rows.map(r => Object.values(r).map(v => `"${String(v).replace(/"/g,'""')}"`).join(','))].join('
');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.setAttribute('download', filename);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// ---------- Simple simulated AI assistant ----------
function smartReply(input, locale='en'){
  const q = input.trim().toLowerCase();
  const en = {
    hi: 'Hello! I’m your AI Payroll Assistant. Ask me about payments, attendance, compliance, or demo features.',
    payment: 'Payments are issued via secure direct deposit or smart checks. You can simulate a payment from the Payroll tab.',
    hours: 'Hours are tracked using GPS + biometric clock-in. The system flags mismatches automatically.',
    compliance: 'AI Compliance keeps tax rules up-to-date and auto-generates W-2/1099 forms for your review.',
    export: 'You can export employee or payment data as CSV using the Export button on the tables.',
    demo: 'Open the demo dashboard to see payroll history, KPIs, employees, and recent payments. Click any card for details.'
  };
  const es = {
    hi: '¡Hola! Soy tu Asistente de Nómina AI. Pregúntame sobre pagos, asistencia, cumplimiento o la demo.',
    payment: 'Los pagos se envían por depósito directo seguro o cheques inteligentes. Puedes simular un pago en la pestaña Nómina.',
    hours: 'Las horas se registran con GPS + registro biométrico. El sistema marca las discrepancias automáticamente.',
    compliance: 'Cumplimiento AI mantiene las reglas fiscales actualizadas y genera W-2/1099 automáticamente.',
    export: 'Puedes exportar datos de empleados o pagos en CSV usando el botón Exportar en las tablas.',
    demo: 'Abre el panel para ver historial de nómina, KPIs, empleados y pagos recientes. Haz click en cualquier tarjeta para más.'
  };

  const dict = locale === 'es' ? es : en;
  if (!q) return dict.hi;
  if (q.includes('payment') || q.includes('pay') || q.includes('pago') ) return dict.payment;
  if (q.includes('hour') || q.includes('hours') || q.includes('horas')) return dict.hours;
  if (q.includes('compliance') || q.includes('tax') || q.includes('cumplim')) return dict.compliance;
  if (q.includes('export') || q.includes('csv')) return dict.export;
  if (q.includes('demo') || q.includes('dashboard')) return dict.demo;
  return locale === 'es' ? 'Lo siento — puedo ayudar con pagos, asistencia, cumplimiento y exportaciones.' : 'Sorry — I can help with payments, attendance, compliance and exports.';
}

// ---------- Main App Component ----------
export default function AIPayrollFullDemo(){
  const [employees, setEmployees] = useState(employeesMock);
  const [payments, setPayments] = useState(paymentsMock);
  const [query, setQuery] = useState('');
  const [roleFilter, setRoleFilter] = useState('All');
  const [locale, setLocale] = useState('en');

  // Chat
  const [chatOpen, setChatOpen] = useState(false);
  const [chatHistory, setChatHistory] = useState([{who:'ai', text: smartReply('', locale)}]);
  const [chatInput, setChatInput] = useState('');

  useEffect(()=>{ // update assistant greeting when locale changes
    setChatHistory([{who:'ai', text: smartReply('', locale)}]);
  },[locale]);

  const roles = useMemo(()=>['All', ...new Set(employees.map(e=>e.role))], [employees]);

  const filteredEmployees = useMemo(()=>{
    return employees.filter(e => (roleFilter==='All' || e.role === roleFilter) && (e.name.toLowerCase().includes(query.toLowerCase()) || String(e.id).includes(query)));
  }, [employees, query, roleFilter]);

  const totalPayroll = useMemo(()=> payments.reduce((s,p)=> s + Number(p.amount), 0), [payments]);

  function handleSendChat(){
    if(!chatInput.trim()) return;
    const userMsg = chatInput.trim();
    setChatHistory(h => [...h, {who:'user', text: userMsg}]);
    const reply = smartReply(userMsg, locale);
    // simulate thinking
    setTimeout(()=> setChatHistory(h => [...h, {who:'ai', text: reply}]), 500);
    setChatInput('');
  }

  function simulatePayAll(){
    // mark scheduled as Paid
    setPayments(prev => prev.map(p => ({...p, status: p.status === 'Scheduled' ? 'Paid' : p.status})));
    setChatHistory(h => [...h, {who:'ai', text: locale==='es' ? 'Simulación: todos los pagos programados se marcaron como Pagados.' : 'Simulation: all scheduled payments were marked Paid.'}]);
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-neutral-900 via-slate-900 to-slate-800 text-gray-100">
      <header className="max-w-7xl mx-auto p-6 flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-extrabold text-cyan-300">AI Payroll Systems</h1>
          <p className="text-sm text-gray-300">The new era of payroll — automated • intelligent • reliable</p>
        </div>
        <div className="flex items-center gap-4">
          <div className="flex items-center gap-2 bg-slate-800 px-3 py-2 rounded-md border border-slate-700">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" className="text-cyan-300"><path d="M12 1v22" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/><path d="M1 12h22" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/></svg>
            <div className="text-sm text-gray-300">Live demo</div>
          </div>
          <select className="bg-slate-800 text-gray-200 px-3 py-2 rounded-md border border-slate-700" value={locale} onChange={e=>setLocale(e.target.value)}>
            <option value="en">English</option>
            <option value="es">Español</option>
          </select>
          <button onClick={()=> window.open('/dashboard', '_blank') } className="bg-cyan-500 hover:bg-cyan-600 px-4 py-2 rounded-md font-semibold">Open App</button>
        </div>
      </header>

      <main className="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Left column: KPIs and charts */}
        <section className="lg:col-span-2 space-y-6">
          <motion.div initial={{opacity:0, y:10}} animate={{opacity:1, y:0}} className="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div className="p-4 bg-slate-800 rounded-lg border border-slate-700">
              <div className="text-sm text-gray-400">Total Employees</div>
              <div className="text-2xl font-bold mt-2">{employees.length}</div>
              <div className="text-xs text-gray-400 mt-1">Active and subcontractors</div>
            </div>
            <div className="p-4 bg-slate-800 rounded-lg border border-slate-700">
              <div className="text-sm text-gray-400">Payroll This Quarter</div>
              <div className="text-2xl font-bold mt-2">{formatCurrency(totalPayroll)}</div>
              <div className="text-xs text-gray-400 mt-1">Auto-calculated by AI engine</div>
            </div>
            <div className="p-4 bg-slate-800 rounded-lg border border-slate-700">
              <div className="text-sm text-gray-400">AI Accuracy</div>
              <div className="text-2xl font-bold mt-2">99.9%</div>
              <div className="text-xs text-gray-400 mt-1">Automated anomaly detection</div>
            </div>
          </motion.div>

          <motion.div initial={{opacity:0}} animate={{opacity:1}} className="p-4 bg-slate-800 rounded-lg border border-slate-700">
            <div className="flex items-center justify-between mb-3">
              <h2 className="text-lg font-semibold">Payroll trend (6 months)</h2>
              <div className="text-sm text-gray-400">Projected vs Actual</div>
            </div>
            <div style={{width: '100%', height: 260}}>
              <ResponsiveContainer>
                <LineChart data={payrollSeries}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#222" />
                  <XAxis dataKey="month" stroke="#888" />
                  <YAxis stroke="#888" tickFormatter={v=>'$'+(v/1000)+'k'} />
                  <Tooltip formatter={(v)=> formatCurrency(v)} />
                  <Line type="monotone" dataKey="payroll" stroke="#06b6d4" strokeWidth={3} dot={{ r:3 }} />
                </LineChart>
              </ResponsiveContainer>
            </div>
          </motion.div>

          <motion.div className="p-4 bg-slate-800 rounded-lg border border-slate-700">
            <div className="flex items-center justify-between mb-3">
              <h2 className="text-lg font-semibold">Payroll by Role (sample)</h2>
              <div className="text-sm text-gray-400">Snapshot</div>
            </div>
            <div style={{ width: '100%', height: 180 }}>
              <ResponsiveContainer>
                <BarChart data={Object.entries(employees.slice(0,5).reduce((acc,e)=>{ acc[e.role] = (acc[e.role] || 0) + (e.hours*e.rate); return acc; },{})).map(([k,v])=>({ role:k, value:v }))}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#222" />
                  <XAxis dataKey="role" stroke="#888" />
                  <YAxis stroke="#888" tickFormatter={v=> '$' + Math.round(v/1000) + 'k'} />
                  <Tooltip formatter={(v)=> formatCurrency(v)} />
                  <Bar dataKey="value" fill="#06b6d4" />
                </BarChart>
              </ResponsiveContainer>
            </div>
          </motion.div>

          <motion.div className="p-4 bg-slate-800 rounded-lg border border-slate-700 flex items-center justify-between">
            <div>
              <h3 className="text-lg font-semibold">Live Actions</h3>
              <p className="text-sm text-gray-400">Try the simulated flows below to demonstrate features.</p>
            </div>
            <div className="flex gap-3">
              <button onClick={()=> downloadCSV('employees.csv', employees)} className="px-4 py-2 bg-slate-700 rounded-md border border-slate-600">Export Employees</button>
              <button onClick={()=> downloadCSV('payments.csv', payments)} className="px-4 py-2 bg-slate-700 rounded-md border border-slate-600">Export Payments</button>
              <button onClick={simulatePayAll} className="px-4 py-2 bg-cyan-500 rounded-md font-semibold">Simulate Pay</button>
            </div>
          </motion.div>
        </section>

        {/* Right column: Employees + Payments */}
        <aside className="space-y-6">
          <div className="p-4 bg-slate-800 rounded-lg border border-slate-700">
            <div className="flex items-center justify-between mb-3">
              <h2 className="text-lg font-semibold">Employees</h2>
              <div className="text-sm text-gray-400">{filteredEmployees.length} results</div>
            </div>
            <div className="flex gap-2 mb-3">
              <input placeholder={locale==='es' ? 'Buscar por nombre o ID' : 'Search name or ID'} value={query} onChange={e=>setQuery(e.target.value)} className="flex-1 px-3 py-2 rounded-md bg-slate-900 border border-slate-700 outline-none" />
              <select value={roleFilter} onChange={e=>setRoleFilter(e.target.value)} className="px-3 py-2 rounded-md bg-slate-900 border border-slate-700">
                {roles.map(r=> <option key={r} value={r}>{r}</option>)}
              </select>
              <button onClick={()=> downloadCSV('employees_filtered.csv', filteredEmployees)} className="px-3 py-2 rounded-md bg-slate-700 border border-slate-600">Export</button>
            </div>

            <div className="max-h-64 overflow-auto">
              <table className="w-full text-sm">
                <thead className="text-gray-400 sticky top-0 bg-slate-800">
                  <tr><th className="text-left p-2">ID</th><th className="text-left p-2">Name</th><th className="p-2">Role</th><th className="p-2">Hours</th><th className="p-2">Rate</th></tr>
                </thead>
                <tbody>
                  {filteredEmployees.map(e => (
                    <tr key={e.id} className="border-t border-slate-700 hover:bg-slate-900">
                      <td className="p-2 text-gray-300">{e.id}</td>
                      <td className="p-2">{e.name}</td>
                      <td className="p-2">{e.role}</td>
                      <td className="p-2">{e.hours}h</td>
                      <td className="p-2">{formatCurrency(e.rate)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>

          <div className="p-4 bg-slate-800 rounded-lg border border-slate-700">
            <div className="flex items-center justify-between mb-3">
              <h2 className="text-lg font-semibold">Recent Payments</h2>
              <div className="text-sm text-gray-400">{payments.length} rows</div>
            </div>
            <div className="max-h-64 overflow-auto">
              <table className="w-full text-sm">
                <thead className="text-gray-400 sticky top-0 bg-slate-800">
                  <tr><th className="text-left p-2">#</th><th className="text-left p-2">Employee</th><th className="p-2">Amount</th><th className="p-2">Status</th></tr>
                </thead>
                <tbody>
                  {payments.map(p=> (
                    <tr key={p.id} className="border-t border-slate-700 hover:bg-slate-900">
                      <td className="p-2 text-gray-300">{p.id}</td>
                      <td className="p-2">{p.employee} <div className="text-xs text-gray-500">{p.role}</div></td>
                      <td className="p-2">{formatCurrency(p.amount)}</td>
                      <td className="p-2">{p.status === 'Paid' ? <span className="text-green-400 font-semibold">{p.status}</span> : p.status === 'Processing' ? <span className="text-amber-400">{p.status}</span> : <span className="text-blue-300">{p.status}</span>}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <div className="mt-3 flex justify-end gap-2">
              <button onClick={()=> downloadCSV('payments_snapshot.csv', payments)} className="px-3 py-2 rounded-md bg-slate-700 border border-slate-600">Export</button>
              <button onClick={simulatePayAll} className="px-3 py-2 rounded-md bg-cyan-500">Simulate Pay</button>
            </div>
          </div>

          <div className="p-4 bg-slate-800 rounded-lg border border-slate-700">
            <h2 className="text-lg font-semibold mb-2">Security & Compliance</h2>
            <ul className="text-sm text-gray-300 list-inside list-disc">
              <li>AES-256 data encryption (at rest & in transit)</li>
              <li>Role-based access and audit logs</li>
              <li>Automated tax form generation</li>
              <li>SOC / ISO-ready architecture</li>
            </ul>
          </div>
        </aside>
      </main>

      {/* Floating Chat */}
      <div style={{position:'fixed', right:24, bottom:24, width:360, maxWidth:'calc(100% - 48px)'}}>
        <motion.div initial={{y:30, opacity:0}} animate={{y:0, opacity:1}} className="bg-slate-800 rounded-xl border border-slate-700 shadow-xl overflow-hidden">
          <div className="bg-cyan-500 px-4 py-2 flex items-center justify-between">
            <div className="font-semibold text-black">AI Payroll Assistant</div>
            <div className="flex items-center gap-2">
              <div className="text-sm text-black">{locale === 'es' ? 'ES' : 'EN'}</div>
              <button onClick={()=> setChatOpen(o=>!o)} className="text-black font-semibold">{chatOpen ? 'Close' : 'Open'}</button>
            </div>
          </div>

          {chatOpen && (
            <div style={{height:320, display:'flex', flexDirection:'column'}}>
              <div style={{flex:1, padding:12, overflowY:'auto'}}>
                {chatHistory.map((m,idx)=> (
                  <div key={idx} style={{marginBottom:8}}>
                    <div style={{fontSize:12, color:'#94a3b8'}}>{m.who === 'ai' ? (locale==='es' ? 'Assistant' : 'AI') : (locale==='es' ? 'Tú' : 'You')}</div>
                    <div style={{background: m.who==='ai' ? '#0f172a' : '#06b6d4', color: m.who==='ai' ? '#e6eef8' : '#000', padding:8, borderRadius:8, display:'inline-block', maxWidth:'88%'}}>{m.text}</div>
                  </div>
                ))}
              </div>
              <div style={{display:'flex', gap:8, padding:10, borderTop:'1px solid rgba(255,255,255,0.03)'}}>
                <input value={chatInput} onChange={e=>setChatInput(e.target.value)} onKeyDown={e=> e.key==='Enter' && handleSendChat()} placeholder={locale==='es' ? 'Pregunta sobre nómina...' : 'Ask about payroll...'} style={{flex:1, padding:10, borderRadius:8, background:'#0b1220', border:'1px solid #1f2937', color:'#e6eef8'}} />
                <button onClick={handleSendChat} style={{background:'#06b6d4', color:'#000', padding:'10px 12px', borderRadius:8, fontWeight:700}}>Send</button>
              </div>
            </div>
          )}
        </motion.div>
      </div>

      <footer className="max-w-7xl mx-auto p-6 text-center text-sm text-gray-500">© 2025 AI Payroll Systems — Demo. For presentations only.</footer>
    </div>
  );
}
